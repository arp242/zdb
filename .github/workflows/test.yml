name: 'test'
on:
  pull_request:
    paths: ['**.go', 'go.mod', '.github/workflows/*']
  push:
    branches: ['main']

jobs:
  staticcheck:
    runs-on: 'ubuntu-latest'
    steps:
      - uses: 'actions/checkout@v6'
      - uses: 'dominikh/staticcheck-action@v1.3.1'
        with: {version: '2025.1'}

  test:
    runs-on: 'ubuntu-latest'
    steps:
      - uses: 'actions/checkout@v6'
      - uses: 'actions/setup-go@v6'
        with: {go-version: 'stable'}
      - run: |
          go test -race ./...
          cd test
          go test -race ./...

          docker compose up -d --wait || {
            docker compose logs
            exit 1
          }

          go test -race -tags=testpq  ./...
          go test -race -tags=testpgx ./...
